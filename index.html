<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>找資料夾遊戲</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      text-align: center;
      background-color: #111;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      border: 2px solid white;
      margin-top: 10px;
    }
    #message {
      margin-top: 10px;
      font-size: 22px;
    }
    button {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      background: #ffcc00;
    }
  </style>
</head>
<body>
  <h1>🔍 找到真正的資料夾！</h1>
  <canvas id="gameCanvas" width="800" height="500"></canvas>
  <div id="message">點擊開始遊戲</div>
  <div id="timer"></div>
  <button id="restartBtn" style="display:none;">重新挑戰</button>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const message = document.getElementById("message");
    const timerDisplay = document.getElementById("timer");
    const restartBtn = document.getElementById("restartBtn");

    let currentLevel = 0;
    let timeLeft = 0;
    let timer = null;
    let refreshInterval = null;
    let folders = [];
    let gameOver = false;
    let gameStarted = false;

    // 統一資料夾尺寸
    const folderW = 50, folderH = 40;

    // 畫資料夾圖示（長得一模一樣）
    function drawFolder(x, y, fileType = null) {
      // folder body
      ctx.fillStyle = "#ffcc00";
      ctx.fillRect(x, y, folderW, folderH);
      // folder tab
      ctx.fillStyle = "#cc9900";
      ctx.fillRect(x, y - 10, 20, 15);
      // 檔案圖示
      if (fileType) {
        drawFileIcon(x + 5, y + 10, fileType);
      }
    }

    // 畫檔案icon（放在資料夾上）
    function drawFileIcon(x, y, type) {
      ctx.fillStyle = "white";
      ctx.fillRect(x, y, 40, 20);
      ctx.fillStyle = "black";
      ctx.font = "13px sans-serif";
      ctx.fillText(type, x + 6, y + 15);
    }

    function drawBackground(level) {
      const colors = ["#333366","#336633","#663333"];
      ctx.fillStyle = colors[level];
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    function drawWin() {
      ctx.fillStyle = "#222";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "lime";
      ctx.font = "40px sans-serif";
      ctx.fillText("🎉 通關成功！", 250, 250);
    }

    function drawLose() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "red";
      ctx.font = "40px sans-serif";
      ctx.fillText("❌ 挑戰失敗！", 250, 250);
    }

    function startTimer(limit) {
      timeLeft = limit;
      timerDisplay.textContent = "剩餘時間: " + timeLeft + " 秒";
      timer = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = "剩餘時間: " + timeLeft + " 秒";
        if (timeLeft <= 0) {
          endGame(false);
        }
      }, 1000);
    }

    function clearIntervals() {
      clearInterval(timer);
      clearInterval(refreshInterval);
      timer = null;
      refreshInterval = null;
    }

    function startLevel(level) {
      clearIntervals();
      gameOver = false;
      folders = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground(level);

      message.textContent = "第 " + (level + 1) + " 關";
      timerDisplay.textContent = "";

      let folderCount;
      let limit;
      if (level === 0) { folderCount = 3; limit = 10; }
      if (level === 1) { folderCount = 8; limit = 15; }
      if (level === 2) { folderCount = 12; limit = 30; }

      // 只有檔案不同
      // 假資料夾的檔案類型
      const fakeTypeArr = ["IMG", "MP3", "MP4"];
      // 真資料夾檔案
      const realType = "FOLDER";

      function spawnFolders() {
        folders = [];
        // 先決定真資料夾位置
        const realIndex = Math.floor(Math.random() * folderCount);
        for (let i = 0; i < folderCount; i++) {
          const x = Math.random() * (canvas.width - folderW);
          const y = Math.random() * (canvas.height - folderH - 10) + 10;
          let fileType = i === realIndex ? realType : fakeTypeArr[Math.floor(Math.random() * fakeTypeArr.length)];
          drawFolder(x, y, fileType);
          folders.push({
            x, y, w: folderW, h: folderH, 
            isReal: i === realIndex, 
            fileType,
            transformed: false
          });
        }
      }

      spawnFolders();

      if (level === 2) {
        refreshInterval = setInterval(() => {
          if (gameOver) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawBackground(level);
          spawnFolders();
        }, 3000);
      }

      startTimer(limit);
    }

    function endGame(win) {
      if (gameOver) return;
      gameOver = true;
      clearIntervals();
      timerDisplay.textContent = "";
      if (win) {
        drawWin();
        message.textContent = "🎉 你贏了！";
      } else {
        drawLose();
        message.textContent = "❌ 時間到！";
      }
      restartBtn.style.display = "inline-block";
    }

    // 統一點擊事件
    function handleCanvasClick(e) {
      if (!gameStarted || gameOver) return;
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      for (let f of folders) {
        if (
          clickX >= f.x && clickX <= f.x + f.w &&
          clickY >= f.y - 10 && clickY <= f.y + f.h
        ) {
          if (f.isReal) {
            currentLevel++;
            if (currentLevel < 3) {
              startLevel(currentLevel);
            } else {
              endGame(true);
            }
            return;
          } else {
            if (!f.transformed) {
              f.transformed = true;
              ctx.clearRect(f.x, f.y - 10, f.w, f.h + 15);
              // 點錯假資料夾，閃現檔案 icon，再變回資料夾
              drawFolder(f.x, f.y, f.fileType); // 仍畫同樣外觀和檔案
              setTimeout(() => {
                if (!gameOver) {
                  ctx.clearRect(f.x, f.y - 10, f.w, f.h + 15);
                  drawFolder(f.x, f.y, f.fileType);
                }
              }, 1000);
              message.textContent = "❌ 假的資料夾！";
            }
          }
        }
      }
    }

    // 初始化
    function resetGameDisplay() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground(0);
      message.textContent = "點擊畫布開始遊戲";
      timerDisplay.textContent = "";
      restartBtn.style.display = "none";
      gameStarted = false;
      gameOver = false;
      currentLevel = 0;
      folders = [];
    }

    canvas.addEventListener("click", function initialClick() {
      if (gameStarted) return;
      gameStarted = true;
      currentLevel = 0;
      startLevel(currentLevel);
    });

    canvas.addEventListener("click", handleCanvasClick);

    restartBtn.addEventListener("click", () => {
      resetGameDisplay();
      gameStarted = true;
      startLevel(0);
    });

    // 頁面載入時重設
    resetGameDisplay();
  </script>
</body>
</html>
