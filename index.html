<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ‰¾è³‡æ–™å¤¾éŠæˆ²</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      text-align: center;
      background-color: #111;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      border: 2px solid white;
      margin-top: 10px;
    }
    #message {
      margin-top: 10px;
      font-size: 22px;
    }
    button {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      background: #ffcc00;
    }
  </style>
</head>
<body>
  <h1>ğŸ” æ‰¾åˆ°çœŸæ­£çš„è³‡æ–™å¤¾ï¼</h1>
  <canvas id="gameCanvas" width="800" height="500"></canvas>
  <div id="message">é»æ“Šé–‹å§‹éŠæˆ²</div>
  <div id="timer"></div>
  <button id="restartBtn" style="display:none;">é‡æ–°æŒ‘æˆ°</button>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const message = document.getElementById("message");
    const timerDisplay = document.getElementById("timer");
    const restartBtn = document.getElementById("restartBtn");

    let currentLevel = 0;
    let timeLeft = 0;
    let timer = null;
    let refreshInterval = null;
    let folders = [];
    let gameOver = false;
    let gameStarted = false;

    // çµ±ä¸€è³‡æ–™å¤¾å°ºå¯¸
    const folderW = 50, folderH = 40;

    // ç•«è³‡æ–™å¤¾åœ–ç¤ºï¼ˆé•·å¾—ä¸€æ¨¡ä¸€æ¨£ï¼‰
    function drawFolder(x, y, fileType = null) {
      // folder body
      ctx.fillStyle = "#ffcc00";
      ctx.fillRect(x, y, folderW, folderH);
      // folder tab
      ctx.fillStyle = "#cc9900";
      ctx.fillRect(x, y - 10, 20, 15);
      // æª”æ¡ˆåœ–ç¤º
      if (fileType) {
        drawFileIcon(x + 5, y + 10, fileType);
      }
    }

    // ç•«æª”æ¡ˆiconï¼ˆæ”¾åœ¨è³‡æ–™å¤¾ä¸Šï¼‰
    function drawFileIcon(x, y, type) {
      ctx.fillStyle = "white";
      ctx.fillRect(x, y, 40, 20);
      ctx.fillStyle = "black";
      ctx.font = "13px sans-serif";
      ctx.fillText(type, x + 6, y + 15);
    }

    function drawBackground(level) {
      const colors = ["#333366","#336633","#663333"];
      ctx.fillStyle = colors[level];
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    function drawWin() {
      ctx.fillStyle = "#222";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "lime";
      ctx.font = "40px sans-serif";
      ctx.fillText("ğŸ‰ é€šé—œæˆåŠŸï¼", 250, 250);
    }

    function drawLose() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "red";
      ctx.font = "40px sans-serif";
      ctx.fillText("âŒ æŒ‘æˆ°å¤±æ•—ï¼", 250, 250);
    }

    function startTimer(limit) {
      timeLeft = limit;
      timerDisplay.textContent = "å‰©é¤˜æ™‚é–“: " + timeLeft + " ç§’";
      timer = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = "å‰©é¤˜æ™‚é–“: " + timeLeft + " ç§’";
        if (timeLeft <= 0) {
          endGame(false);
        }
      }, 1000);
    }

    function clearIntervals() {
      clearInterval(timer);
      clearInterval(refreshInterval);
      timer = null;
      refreshInterval = null;
    }

    function startLevel(level) {
      clearIntervals();
      gameOver = false;
      folders = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground(level);

      message.textContent = "ç¬¬ " + (level + 1) + " é—œ";
      timerDisplay.textContent = "";

      let folderCount;
      let limit;
      if (level === 0) { folderCount = 3; limit = 10; }
      if (level === 1) { folderCount = 8; limit = 15; }
      if (level === 2) { folderCount = 12; limit = 30; }

      // åªæœ‰æª”æ¡ˆä¸åŒ
      // å‡è³‡æ–™å¤¾çš„æª”æ¡ˆé¡å‹
      const fakeTypeArr = ["IMG", "MP3", "MP4"];
      // çœŸè³‡æ–™å¤¾æª”æ¡ˆ
      const realType = "FOLDER";

      function spawnFolders() {
        folders = [];
        // å…ˆæ±ºå®šçœŸè³‡æ–™å¤¾ä½ç½®
        const realIndex = Math.floor(Math.random() * folderCount);
        for (let i = 0; i < folderCount; i++) {
          const x = Math.random() * (canvas.width - folderW);
          const y = Math.random() * (canvas.height - folderH - 10) + 10;
          let fileType = i === realIndex ? realType : fakeTypeArr[Math.floor(Math.random() * fakeTypeArr.length)];
          drawFolder(x, y, fileType);
          folders.push({
            x, y, w: folderW, h: folderH, 
            isReal: i === realIndex, 
            fileType,
            transformed: false
          });
        }
      }

      spawnFolders();

      if (level === 2) {
        refreshInterval = setInterval(() => {
          if (gameOver) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawBackground(level);
          spawnFolders();
        }, 3000);
      }

      startTimer(limit);
    }

    function endGame(win) {
      if (gameOver) return;
      gameOver = true;
      clearIntervals();
      timerDisplay.textContent = "";
      if (win) {
        drawWin();
        message.textContent = "ğŸ‰ ä½ è´äº†ï¼";
      } else {
        drawLose();
        message.textContent = "âŒ æ™‚é–“åˆ°ï¼";
      }
      restartBtn.style.display = "inline-block";
    }

    // çµ±ä¸€é»æ“Šäº‹ä»¶
    function handleCanvasClick(e) {
      if (!gameStarted || gameOver) return;
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      for (let f of folders) {
        if (
          clickX >= f.x && clickX <= f.x + f.w &&
          clickY >= f.y - 10 && clickY <= f.y + f.h
        ) {
          if (f.isReal) {
            currentLevel++;
            if (currentLevel < 3) {
              startLevel(currentLevel);
            } else {
              endGame(true);
            }
            return;
          } else {
            if (!f.transformed) {
              f.transformed = true;
              ctx.clearRect(f.x, f.y - 10, f.w, f.h + 15);
              // é»éŒ¯å‡è³‡æ–™å¤¾ï¼Œé–ƒç¾æª”æ¡ˆ iconï¼Œå†è®Šå›è³‡æ–™å¤¾
              drawFolder(f.x, f.y, f.fileType); // ä»ç•«åŒæ¨£å¤–è§€å’Œæª”æ¡ˆ
              setTimeout(() => {
                if (!gameOver) {
                  ctx.clearRect(f.x, f.y - 10, f.w, f.h + 15);
                  drawFolder(f.x, f.y, f.fileType);
                }
              }, 1000);
              message.textContent = "âŒ å‡çš„è³‡æ–™å¤¾ï¼";
            }
          }
        }
      }
    }

    // åˆå§‹åŒ–
    function resetGameDisplay() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground(0);
      message.textContent = "é»æ“Šç•«å¸ƒé–‹å§‹éŠæˆ²";
      timerDisplay.textContent = "";
      restartBtn.style.display = "none";
      gameStarted = false;
      gameOver = false;
      currentLevel = 0;
      folders = [];
    }

    canvas.addEventListener("click", function initialClick() {
      if (gameStarted) return;
      gameStarted = true;
      currentLevel = 0;
      startLevel(currentLevel);
    });

    canvas.addEventListener("click", handleCanvasClick);

    restartBtn.addEventListener("click", () => {
      resetGameDisplay();
      gameStarted = true;
      startLevel(0);
    });

    // é é¢è¼‰å…¥æ™‚é‡è¨­
    resetGameDisplay();
  </script>
</body>
</html>
